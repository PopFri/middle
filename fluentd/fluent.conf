<source>
  @type http
  port 9880
  bind 0.0.0.0
  add_http_headers true
  add_remote_addr true
  <parse>
    @type none
  </parse>
</source>

<filter matomo.php>
  @type extract_query_params
  key HTTP_X_REQUEST_URI
  add_field_prefix QUERY_
  discard_key true
</filter>

<match matomo.php>
  @type kafka2

  brokers docker-kafka-1:9092          # Kafka 브로커 주소
  topic_key matomo-log                 # 레코드에서 토픽을 결정할 키
  default_topic matomo-log             # topic_key가 없을 때 사용할 기본 토픽

  <buffer matomo-log>
    @type memory
    flush_interval 1s             # 최대 1초마다 Kafka로 전송
    flush_thread_count 2          # 병렬 전송 (필요 시 2 이상으로)
    chunk_limit_size 512k         # Kafka 기본 메시지 제한(1MB) 아래로 설정
    retry_max_times 10
    retry_wait 1s
    flush_at_shutdown true
    overflow_action block         # 유실 방지: 버퍼 가득 차면 대기
  </buffer>

  <format>
    @type json
  </format>
</match>

<match **>
  @type stdout
</match>